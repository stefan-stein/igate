---
title: "Good/ Bad Pairwise Comparison Analysis Report"
date: "`r format(Sys.time(), '%d/%m/%Y')`"
header-includes:
   - \usepackage{longtable}
   - \usepackage{booktabs}
   - \usepackage{array}
   - \usepackage{pdflscape}
   - \newcommand{\blandscape}{\begin{landscape}}
   - \newcommand{\elandscape}{\end{landscape}}
output: pdf_document
params:
  df_name:  "data_frame"
  versus: 8
  target: "max17_343_36"
  test: "w"
  ssv:  !r c("a", "b", "c")
  outlier_removal_target: !r TRUE
  outlier_removal_ssv: !r TRUE
  good_end: "low"
  results_path: "Data/results.csv"
  good_bad_bands_path: "Data/good_bad_bands.csv"
  validation: !r FALSE
  validation_path: "Data/good_bad_validated_records.csv"
  validation_counts: "Data/good_bad_counts.csv"
---

```{r setup, include=FALSE}
library(knitr)
library(readr)
library(xtable)
library(kableExtra)
library(pander)
knitr::opts_chunk$set(echo = FALSE)
```

```{r, include=FALSE}

#Determine the follow up test used for analysis
follow_up_test <- if(params$test == "w"){"Wilcoxon Rank Test"}else{"Student's t-test"}
results <- read_csv(params$results_path)
good_bad_bands <- read_csv(params$good_bad_bands_path)
if(params$validation){
validation <- read_csv(params$validation_path)
validation_counts <- read_csv(params$validation_counts)
}
```

## Overview

Using the `r params$df_name` data set, we conducted a `r params$versus` good versus `r params$versus` bad pairwise comparison analysis on `r Sys.Date()`. The target variable was `r params$target`. The goal of the analysis was to find process parameters in the `r params$df_name` data set that significantly influence the values of `r params$target`.
For `r params$target`, *`r params$good_end`* values correspond to good values. 

First, the counting method was conducted to obtain a preliminary selection of influential process parameters. Then, the `r follow_up_test` was used as a follow up test. The count obtained from the counting method and the p-value from the `r follow_up_test` have been recorded in Table 2.

For the influential parameters good and bad control bands have been extracted. These are shown in Table 3.

A sanity check was performed for the selected parameters by visually inspecting a regression plot of the ssv against the target and checking for a correlation.

The influential parameters and control bands `r if(params$validation){"have"}else{"have not yet"}` been validated.

The results of the analysis are stored in `r getwd()`.


## Analysis

Outlier removal for the target variable was `r if(params$outlier_removal_target){"conducted, giving the following results."}else{"not conducted"}`. 

```{r, eval= params$outlier_removal_target, out.width='50%', fig.align='center', fig.cap='Boxplot of target variable.', fig.pos= 'h'}
#Determine the filename of boxplot of target
filepath <- paste0("Plots/Boxplot_of_", params$target,".png")
knitr::include_graphics(filepath)
```

The ssv's that were analysed are 
```{r, message=FALSE}
# We want a table with three columns listing the ssv analised
ssv <- as.character(params$ssv)
fill_up <- ifelse(length(ssv) %% 3 == 0, 0, 3 - (length(ssv) %% 3))
list_ssv <- c(ssv,rep(NA,fill_up))
ssv_matrix <- matrix(list_ssv, ncol = 3)
options(knitr.kable.NA = '')
kable(ssv_matrix,
      caption = "Analysed ssv.",
      longtable = TRUE,
      booktabs = TRUE)%>%
    kable_styling(latex_options = c("hold_position", "repeat_header"))%>%
  column_spec(column = 1:3, width = "4cm")

```
Outlier removal for each ssv was `r if(params$outlier_removal_ssv){"conducted"}else{"not conducted"}`.

## Results


The counting method and `r follow_up_test` produced the following results.

```{r countsandps}
pander(results,
       caption = 'Results of the counting method and the Wilcoxon Rank Test.',
       missing = '',
       justify = 'lrrll',
      booktabs = TRUE,
      longtable = TRUE)
# kable(results, 
#       caption = 'Results of the counting method and the Wilcoxon Rank Test.',
#       booktabs = TRUE,
#       longtable = TRUE)%>%
#   kable_styling(latex_options = c("hold_position", "repeat_header"))
```


\blandscape

The counting method and `r follow_up_test` produced the following results.

```{r controlbands}
#Only print bands for kept SSV.
kable(good_bad_bands[,1:9],
      digits = 3,
      caption = 'Control bands for the influential parameters.',
      booktabs = TRUE,
      longtable = TRUE,
      col.names = c("SSV",
                    "lower",
                    "upper",
                    "lower",
                    "upper",
                    "lower",
                    "upper",
                    "lower",
                    "upper"))%>%
  add_header_above(c(" " = 1, "Good Band" = 2, "Bad Band" = 2, "Modified Good Band" = 2, "Modified Bad Band" = 2),
                   bold = TRUE) %>%
  kable_styling(latex_options = c("hold_position", "repeat_header")) %>%
  column_spec(1, border_right = TRUE, width = "5cm")
if(sum(is.na(good_bad_bands[,10])) < nrow(good_bad_bands))
kable(good_bad_bands[,c(1,10)],
      caption = "Comments on modified control bands.",
      booktabs = TRUE,
      longtable = TRUE)%>%
  kable_styling(latex_options = c("hold_position", "repeat_header"))
```
\elandscape

\newpage

## Validation

The influential parameters and control bands `r if(params$validation){"have"}else{"have not yet"}` been validated.

```{r}
if(params$validation){
validation <- validation[order(validation$quality),]
# number_bads <- validation%>%
#   filter(quality == "bad")%>%
#   nrow()
# print(number_bads)
# validation_length <- nrow(validation)
kable(validation,
      caption = 'The records of the validation data set that fall into all the good control bands resp. bad control bands.',
      booktabs = TRUE,
      longtable = TRUE)%>%
  kable_styling(latex_options = c("hold_position", "repeat_header"))
}
```

`r if(params$validation){"The following table shows how many observations would fall into the good/ bad category IF only that one SSV had been analysed. If a count is very low, then that means that this SSV is excluding many observations from the validation output. In that case it might be worthwhile to re-run the validation procedure without that particular SSV."}`

```{r}
if(params$validation){
  kable(validation_counts,
        caption = 'Number of observations falling into the good/ bad bands per SSV.',
      booktabs = TRUE,
      longtable = TRUE)%>%
  kable_styling(latex_options = c("hold_position", "repeat_header"))
}
```




# Appendix

## Regression Plots

The regression plots that were used to determine the final selection of influential process parameters are shwon below.

```{r, results='asis'}
# # We want three plots per row
length_causes <- length(results$Causes)

for (i in 1:length_causes) {
   plot_name <- paste0("Plots/", str_replace_all(results$Causes[i], "[^[:alnum:]]", ""), "_against_", params$target,".png")
   cat("![](", plot_name, "){width=33%}")
   cat('\n')
}

# for (i in length_causes) {
#   plot_path <- paste0(str_replace_all(results$Causes[i], "[^[:alnum:]]", ""), "_against_", params$target)
#   cat(paste("\\includesvg{", plot_path,"}\n", sep=""))
# }





# # Only prints last plot
# for (i in length_causes) {
#   plot_path <- paste0("Plots/", str_replace_all(results$Causes[i], "[^[:alnum:]]", ""), " against ", params$target,".png")
#   cat(paste("\\includegraphics[width=0.33\\textwidth,",
#             "height=\\textheight,keepaspectratio]{", plot_path,"}\n", sep=""))
#   if(i %% 3 == 0){
#     cat('\n')
#   }
# }


# #Does not work with for loop
  # left_plot_name <- paste0(str_replace_all(params$ssv[13], "[^[:alnum:]]", ""), " against ", params$target,".png")
  # center_plot_name <- "loss17b33736 against max17_343_36.png"
  # right_plot_name <- "mean1734036 against max17_343_36.png"
  # knitr::include_graphics(c(left_plot_name, center_plot_name, right_plot_name))
  # 
  # left_plot_name <- paste0(str_replace_all(params$ssv[10], "[^[:alnum:]]", ""), " against ", params$target,".png")
  # center_plot_name <- paste0(str_replace_all(params$ssv[11], "[^[:alnum:]]", ""), " against ", params$target,".png")
  # right_plot_name <- paste0(str_replace_all(params$ssv[12], "[^[:alnum:]]", ""), " against ", params$target,".png")
  # 
  # knitr::include_graphics(c(left_plot_name, center_plot_name, right_plot_name))


```






